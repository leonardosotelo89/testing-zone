<html lang="en">
  <head>
<meta charset="UTF-8">
<meta 
name="viewport" 
content="width=device-width,
         height=device-height, 
         initial-scale=1.0">

    <title></title>
    <style>
*{margin:0px;padding:0px;}
    body{
      background-color: rgb(0,0,0);
      color: lime;
} 
h2{
  animation:colores 7s 1s linear infinite;
}
@keyframes colores{
  from{
   filter: hue-rotate(0deg);
  }to{
    filter: hue-rotate(360deg);
  }
}
#div1{
  position: absolute ;
  left: 0px ;
  top: 0px;
  width: 100%;
  height: 100%;
  display: grid ;
  place-items: center ;
}
span{
  width: 100px ;
  padding: 30px ;
  border: 2px solid blue ;
  display: grid ;
  place-items: center ;
  color: white ;
  background-color: red;
  font-size: 30px ;
}
#div3{
  font-size:40px ;
}
#forvolume{
  position: absolute ;
  right: 25px ;
  top: 100px;
  width: 100px ;
  height: 350px;
  border: 2px solid white ;
  background-image:linear-gradient(to top, lime 50%, red);
  overflow:hidden ;
}
#curtain{
  position: absolute ;
  right: 0px ;
  top: -300px;
  width: 100px ;
  height: 350px;
  border: 2px solid transparent ;
  border-bottom:2px solid white ;
  background:black ;
}
#round{
  position: absolute ;
  top:100px;
  right: 50px;
  width: 50px;
  height: 50px;
  background-color: blue ;
  border-radius: 50%;
}
#forbgplay{
  width: 400px;
  height: 100px ;
  font-size: 30px ;
  color: white ;
  background-color: red;
  border: 2px solid blue ;
  padding: 10px ;
  position: absolute ;
  bottom: 0px ;
  display: grid ;
  place-items: center ;
}
#formute{
  position: absolute ;
  right: 0px ;
  bottom: 250px ;
  width: 150px;
  height: 100px ;
  font-size: 30px ;
  color: white ;
  background-color:green;
  border: 2px solid blue ;
  display: grid ;
  place-items: center ;
}
#volumebars{
  position:absolute ;
  bottom:150px ;
  left:50px ;
  border:2px solid white ;
}
    </style>
  </head>
  
  <body>
    
    <h2>html5</h2>
<div id="div1">
  <span id="status">stopped</span>
  </div>
<div id="div2">
</div>
<div id="div3"></div>


<div id="forvolume">
    <div id="curtain"></div>
</div>
 <div id="round"></div>
 
 <div id="formute">mute</div>

<canvas id="volumebars" width="300" height="200"></canvas>

<div id="forbgplay">background play deactivated</div>
<script>
  
let mainaudio = new Audio()
mainaudio.id = 'mainaudio'
div2.appendChild(mainaudio)
mainaudio.controls = true
console.log('mainaudio', mainaudio) 
  
let start = false
let bgplay = false
let silence = false
let masterindex = 0

//if only one span element tag name is enough 
let status = document.querySelector('span')
let input1 = document.querySelector('input')
let forbgplay = document.querySelector('#forbgplay')

let speeches = []
speeches[0] = 'aaa.mp3'
speeches[1] = 'bbb.mp3'
speeches[2] = 'ccc.mp3'

let music = []

music[0] = 'pika pika.mp3'
music[1] = 'cuek.mp3'

let arrays = [speeches, music]

//store played
let playedspeeches = []
let playedmusic = []

let played = [playedspeeches, playedmusic]

function randomfrom(array){
  let random = parseInt(Math.random()*array.length)
  let chosen 
  do{
   chosen = arrays[masterindex][random]
  }while (played[masterindex].includes(chosen))
  played[masterindex].push(chosen)
  if(played[masterindex].length == arrays[masterindex].length) {played[masterindex] = []} 
  console.log(playedspeeches, playedmusic ) 

  masterindex = 
  masterindex >= arrays.length - 1? 0 : ++masterindex
  return chosen
}



function show(){
  if(start){
  mainaudio.src = 
  'sonidos mp3/' + randomfrom(arrays)
  mainaudio.currentTime = 0
  mainaudio.play()
  console.log('src', mainaudio.attributes.src.value)
  }
}

mainaudio.onended = function(){
    show()
}

status.onclick = function(){
  start = start ? false : true 
  if(start) show()
  if(!start) mainaudio.pause()
  status.innerHTML = start ? 'playing' : 'stopped'
  status.style.background = !start ? 'red' : 'green'
}

let loop = setInterval(()=>{
  div3.innerHTML = 
  "<br>duration: " + mainaudio.duration + 
  "<br>currentTime: " + mainaudio.currentTime + 
  "<br>volume: " + parseInt(mainaudio.volume * 100) + "%" +
  "<br>bgplay: " + bgplay +
  "<br>mute: " + silence
}, 10)


//custom range
round.addEventListener('touchmove', function(e){
  let y = e.touches[0].clientY;

  // Set the position within the defined boundaries
  if(y <= 100) y = 100;
  if(y >= 400) y = 400;

  this.style.top = y + "px";
  curtain.style.top = y - 400 + "px"
  // Calculate and set the volume ( 100px & 400px range)
  mainaudio.volume = 1 - (y - 100) / 300;
});

formute.addEventListener('touchstart', ()=>{
  silence = silence ? false : true 
  mainaudio.muted = !silence ? false : true 
  formute.innerHTML = !silence ? 'mute' : 'unmute'
  formute.style.background = silence? 'red' : 'green'
  
})

forbgplay.addEventListener('touchstart', ()=>{
  bgplay = bgplay ? false : true 
  forbgplay.innerHTML = bgplay ? 'background play activated' : 'background play deactivated'
  forbgplay.style.background = !bgplay ? 'red' : 'green'
})

 // Handle visibility change to mute/unmute audio
 document.addEventListener("visibilitychange", function() {
   if(!bgplay){
     //simulate liveshow by only muting the audio 
      if (document.hidden) {
          mainaudio.muted = true
      } else {
          mainaudio.muted = false 
      }
   } 
 });
 
 //volume bars
 const audio = document.getElementById('mainaudio');
 const canvas = document.getElementById('volumebars');
 const ctx = canvas.getContext('2d');
 const audioContext = new (window.AudioContext || window.webkitAudioContext)();
 const analyser = audioContext.createAnalyser();
 const source = audioContext.createMediaElementSource(audio);

  source.connect(analyser);
  analyser.connect(audioContext.destination);
  analyser.fftSize = 256;

  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  function draw() {
      requestAnimationFrame(draw);

      analyser.getByteFrequencyData(dataArray);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const barWidth = (canvas.width / bufferLength) * 2.5;
      let barHeight;
      let x = 0;

      for (let i = 0; i < bufferLength; i++) {
          barHeight = dataArray[i] /1 // /2;
          // Create a linear gradient
// The arguments are the coordinates of the gradient's start point (x0, y0) and end point (x1, y1)
const gradient = ctx.createLinearGradient(x, canvas.height - barHeight, barWidth, canvas.height );

// Add color stops to the gradient (position, color)
gradient.addColorStop(0, 'red');   // Start with red
gradient.addColorStop(0.05, 'yellow'); // Middle is yellow
gradient.addColorStop(0.1, 'green');    // End with green

// Use the gradient to fill a rectangle
ctx.fillStyle = gradient;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

          x += barWidth + 1;
      }
  }

  audio.onplay = () => {
      if (audioContext.state === 'suspended') {
          audioContext.resume();
      }
      draw();
  };
</script>
<footer>            <!--              --></footer>
</body>
</html> 
